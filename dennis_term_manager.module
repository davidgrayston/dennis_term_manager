<?php
/**
 * @file
 */

/**
 * Implement hook_permission().
 */
function dennis_term_manager_permission() {
  return array(
    'administer dennis term manager' => array(
      'title' => t('Administer term manager'),
      'description' => t('Manage Dennis taxonomy terms csv bulk operation'),
    ),
  );
}

/**
 * Implement hook_menu().
 */
function dennis_term_manager_menu() {
  $items = array();
  $items['admin/structure/taxonomy/term_manager'] = array(
    'title' => 'Term Manager',
    'description' => 'Manage bulk taxonomy term operation via CSV file upload',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('dennis_term_manager_form'),
    'access arguments' => array('administer dennis term manager'),
  );
  return $items;
}

/**
 * Implement hook_form().
 * @param unknown_type $form
 * @param unknown_type $form_state
 */
function dennis_term_manager_form($form, &$form_state) {
  $form = array();

  // #managed_file FAPI
  // @todo : change storage to private
  $form['csv_file'] = array(
    '#title' => t('import'),
    '#type' => 'managed_file',
    '#description' => t('The uploaded csv file will be processed.'),
    '#upload_validators' => array(
      'file_validate_extensions' => array('csv'),
    ),
    '#upload_location' => 'public://term_csv/'
  );

  $form['buttons']['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Import'),
  );
  $form['notes'] = array(
    '#type' => 'markup',
    '#markup' => '<div class="import-notes">
    <ul><li>Make sure the file is in a .csv format. And Columns should be in following order.</li>
    <li>vocabulary_machine_name, Term_name, Related_nodes_no, Parent_term, Parent_vocab, Action,Target, New_name</li>
    <li>click the "Upload" button when you select a csv.</li></ul></div>',
    '#upload_location' => 'public://tmp/'
  );

  return $form;
}

/**
 * Implement hook_form_submit().
 * @param unknown_type $form
 * @param unknown_type $form_state
 */
function dennis_term_manager_form_submit(&$form, &$form_state) {
  // Load the file.
  $file = file_load($form_state['values']['csv_file']);
  // Change status to permanent.
  $file->status = FILE_STATUS_PERMANENT;
  $file_path = $file->uri;

  //file content validation.
  dennis_term_manager_csv_import_validate($file_path);

  // Save.
  $uploaded = file_save($file);
  if ($uploaded == TRUE) {
    drupal_set_message(t('The file has been uploaded.'));
  }
  else {
    drupal_set_message(t('The file could not be uploaded. Please contact the site administrator.'), 'error');
  }
}

/**
 * Process csv file and validate its content
 */
function dennis_term_manager_csv_import_validate($file_path) {

  $row = 0;
  $errors = array();
  // get the file content
  if (($handle = fopen($file_path, "r")) !== FALSE) {
    while (($data = fgetcsv($handle, 1000, "\t")) !== FALSE) {
      $row++;
      //skip the header row
      if($row <= 1) {
        continue 1;
      }
      //get the action column data
      $command = $data[5];
      switch ($command) {
        case 'Delete':
          //@todo : validate current row for Term Delete action
          if (!isset($data[0]) || !isset($data[1]) || $data[2] != 0) {
            drupal_set_message(t("Row @row not Valid", array('@row' => $row)));
          }
          break;
        case 'Rename':
          //@todo: validate current row for Term Rename action
          if (!isset($data[0]) || !isset($data[1]) || !isset($data[7])) {
            drupal_set_message(t("Row @row not Valid", array('@row' => $row)));
          }
          break;
        case 'Merge':
          //@todo: validate current row for Term Merge action
          $target = explode(">->", $data[6]);
          if (count($target) <= 1 || !isset($data[0]) || !isset($data[1])) {
            drupal_set_message(t("Row @row not Valid", array('@row' => $row)));
          }
          break;
        case 'Move':
          //@todo: vakudate current row for Term Move action
          if (!isset($data[0]) || !isset($data[1]) || !isset($data[3]) || !isset($data[4])) {
            drupal_set_message(t("Row @row not Valid", array('@row' => $row)));
          }
          break;
        case 'default':
          //no command matched. record error
          //@todo: add error in an array. so we can display on screen.
          drupal_set_message(t("Row @row not Valid", array('@row' => $row)));
      }
    }
    fclose($handle);
  }
}